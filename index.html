<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minute Might Combat Simulator</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Simulating Combat</div>
        <div class="loading-subtext" id="loading-progress">Running simulations...</div>
    </div>

    <header>
        <h1>âš” Minute Might Combat Simulator âš”</h1>
        <p>SCRUD Probability Simulator</p>
        <button class="rules-button" onclick="toggleRulesModal()">ðŸ“œ Game Rules</button>
    </header>

    <!-- Rules Modal -->
    <div class="rules-modal" id="rules-modal">
        <div class="rules-modal-content">
            <div class="rules-modal-header">
                <h2>ðŸ“œ Game Rules</h2>
                <button class="rules-close" onclick="toggleRulesModal()">âœ•</button>
            </div>
            <div class="rules-modal-body">
                <pre class="rules-text" id="rules-text">Loading rules...</pre>
            </div>
        </div>
    </div>

    <main>
        <div class="combat-setup">
            <!-- Attacker Panel -->
            <div class="unit-panel attacker">
                <h2>âš” Attacker</h2>
                
                <div class="form-group">
                    <label>Unit Name</label>
                    <input type="text" id="attacker-name" placeholder="e.g., Heavy Infantry">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Figures</label>
                        <input type="number" id="attacker-figures" value="4" min="1">
                    </div>
                </div>
                
                <!-- Melee Attack Field -->
                <div class="form-group combat-field melee-field">
                    <label>Melee Attack</label>
                    <input type="text" id="attacker-melee" placeholder="e.g., 2d6/1f + 1d8" onblur="validateDiceInput(this)">
                    <p class="help-text">Format: [dice]d[faces]/[figures]f + [flat dice]</p>
                    <p class="validation-message" id="attacker-melee-validation"></p>
                </div>
                
                <!-- Missile Fire Attack Field -->
                <div class="form-group combat-field missile-field" style="display: none;">
                    <label>Missile Fire Attack</label>
                    <input type="text" id="attacker-missile" placeholder="e.g., 1d8/1f" onblur="validateDiceInput(this); checkIndirectFireEligibility()">
                    <p class="help-text">Dice that roll 5+ are hits</p>
                    <p class="validation-message" id="attacker-missile-validation"></p>
                </div>
                
                <!-- Missile Fire Options (only for missile) -->
                <div class="missile-options combat-field missile-field" style="display: none;">
                    <div class="checkbox-group">
                        <input type="checkbox" id="attacker-artillery">
                        <label for="attacker-artillery">Artillery (2 casualties per hit)</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="attacker-indirect">
                        <label for="attacker-indirect">Indirect Fire (d8â†’d6)</label>
                    </div>
                    <p class="help-text" id="indirect-warning" style="display: none; color: var(--accent-attacker);">
                        âš  No d8 dice in pool - indirect fire has no effect
                    </p>
                </div>
                
                <div class="bonus-section">
                    <h3>Bonus Dice</h3>
                    <div class="bonus-select">
                        <label class="bonus-option">
                            <input type="radio" name="attacker-bonus" value="none" checked>
                            <span>None</span>
                        </label>
                        <label class="bonus-option">
                            <input type="radio" name="attacker-bonus" value="standard">
                            <span>50% Bonus</span>
                        </label>
                        <label class="bonus-option">
                            <input type="radio" name="attacker-bonus" value="double">
                            <span>100% Bonus</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="control-panel">
                <div class="combat-mode">
                    <h3>Combat Mode</h3>
                    <div class="mode-toggle">
                        <label>
                            <input type="radio" name="combat-mode" value="melee" checked>
                            Melee Combat
                        </label>
                        <label>
                            <input type="radio" name="combat-mode" value="missile">
                            Missile Fire
                        </label>
                    </div>
                </div>
                
                <div class="sim-count">
                    <label>Simulations (100 - 50,000)</label>
                    <input type="number" id="sim-count" value="10000" min="100" max="50000" step="1000">
                </div>
                
                <button class="run-button" onclick="runSimulation()">
                    Run Simulation
                </button>
            </div>

            <!-- Defender Panel -->
            <div class="unit-panel defender">
                <h2>ðŸ›¡ Defender</h2>
                
                <div class="form-group">
                    <label>Unit Name</label>
                    <input type="text" id="defender-name" placeholder="e.g., Spearmen">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Figures</label>
                        <input type="number" id="defender-figures" value="4" min="1">
                    </div>
                </div>
                
                <!-- Melee Attack Field -->
                <div class="form-group combat-field melee-field">
                    <label>Melee Attack</label>
                    <input type="text" id="defender-melee" placeholder="e.g., 1d6/1f" onblur="validateDiceInput(this)">
                    <p class="validation-message" id="defender-melee-validation"></p>
                </div>
                
                <!-- Missile Dodge Field -->
                <div class="form-group combat-field missile-field" style="display: none;">
                    <label>Missile Dodge</label>
                    <input type="text" id="defender-dodge" placeholder="e.g., 1d6/1f" onblur="validateDiceInput(this)">
                    <p class="help-text">Max dice rolled = successes, limited by figures</p>
                    <p class="validation-message" id="defender-dodge-validation"></p>
                </div>
                
                <div class="bonus-section">
                    <h3>Bonus Dice</h3>
                    <div class="bonus-select">
                        <label class="bonus-option">
                            <input type="radio" name="defender-bonus" value="none" checked>
                            <span>None</span>
                        </label>
                        <label class="bonus-option">
                            <input type="radio" name="defender-bonus" value="standard">
                            <span>50% Bonus</span>
                        </label>
                        <label class="bonus-option">
                            <input type="radio" name="defender-bonus" value="double">
                            <span>100% Bonus</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="results">
            <h2 class="results-header">Simulation Results</h2>
            
            <div class="results-grid">
                <!-- Victory Probability -->
                <div class="result-card">
                    <h3>Victory Probability</h3>
                    <div class="victory-chart" id="victory-chart">
                        <div class="bar-container">
                            <div class="bar-wrapper">
                                <div class="bar attacker" id="bar-attacker" style="height: 0;">
                                    <span class="bar-value" id="val-attacker">0%</span>
                                </div>
                            </div>
                            <span class="bar-label">Attacker</span>
                        </div>
                        <div class="bar-container">
                            <div class="bar-wrapper">
                                <div class="bar draw" id="bar-draw" style="height: 0;">
                                    <span class="bar-value" id="val-draw">0%</span>
                                </div>
                            </div>
                            <span class="bar-label">Draw</span>
                        </div>
                        <div class="bar-container">
                            <div class="bar-wrapper">
                                <div class="bar defender" id="bar-defender" style="height: 0;">
                                    <span class="bar-value" id="val-defender">0%</span>
                                </div>
                            </div>
                            <span class="bar-label">Defender</span>
                        </div>
                    </div>
                </div>

                <!-- Combat Summary -->
                <div class="result-card">
                    <h3>Combat Summary</h3>
                    <table class="stats-table">
                        <tr>
                            <th>Metric</th>
                            <th>Attacker</th>
                            <th>Defender</th>
                        </tr>
                        <tr>
                            <td>Avg. Casualties Inflicted</td>
                            <td class="stat-attacker" id="avg-cas-attacker">-</td>
                            <td class="stat-defender" id="avg-cas-defender">-</td>
                        </tr>
                        <tr>
                            <td>Avg. Comparisons Won</td>
                            <td class="stat-attacker" id="avg-wins-attacker">-</td>
                            <td class="stat-defender" id="avg-wins-defender">-</td>
                        </tr>
                        <tr>
                            <td>Avg. Dice in Pool</td>
                            <td class="stat-attacker" id="avg-dice-attacker">-</td>
                            <td class="stat-defender" id="avg-dice-defender">-</td>
                        </tr>
                        <tr id="missile-shots-row" style="display: none;">
                            <td>Avg. Successful Shots (5+)</td>
                            <td class="stat-attacker" id="avg-shots-attacker">-</td>
                            <td class="stat-defender">N/A</td>
                        </tr>
                        <tr id="missile-dodges-row" style="display: none;">
                            <td>Avg. Successful Dodges</td>
                            <td class="stat-attacker">N/A</td>
                            <td class="stat-defender" id="avg-dodges-defender">-</td>
                        </tr>
                        <tr id="missile-ties-row" style="display: none;">
                            <td>Avg. Tied Comparisons</td>
                            <td class="stat-attacker" id="avg-ties" colspan="2" style="text-align: center;">-</td>
                        </tr>
                    </table>
                </div>

                <!-- Casualties Distribution - Attacker Inflicted -->
                <div class="result-card">
                    <div class="histogram-container">
                        <div class="histogram-title-row">
                            <h3>Casualties Inflicted by Attacker 
                                <span id="artillery-indicator" style="display: none; color: var(--accent-gold); font-size: 0.7rem;">(Artillery: 2Ã—)</span>
                                <span id="indirect-indicator" style="display: none; color: var(--text-secondary); font-size: 0.7rem;">(Indirect: d8â†’d6)</span>
                            </h3>
                        </div>
                        <p class="histogram-explanation">Each bar shows how often that number of casualties occurred across all simulations</p>
                        <div class="histogram-chart">
                            <span class="histogram-y-label">Frequency</span>
                            <div class="histogram" id="hist-attacker"></div>
                        </div>
                        <div class="histogram-x-label">Number of Casualties</div>
                        <div class="sigma-stats" id="sigma-attacker">
                            <div class="sigma-stat">
                                <div class="sigma-stat-label">Mean (Î¼)</div>
                                <div class="sigma-stat-value attacker" id="sigma-attacker-mean">-</div>
                            </div>
                            <div class="sigma-stat">
                                <div class="sigma-stat-label">Std Dev (Ïƒ)</div>
                                <div class="sigma-stat-value attacker" id="sigma-attacker-std">-</div>
                            </div>
                            <div class="sigma-stat">
                                <div class="sigma-stat-label">Min</div>
                                <div class="sigma-stat-value attacker" id="sigma-attacker-min">-</div>
                            </div>
                            <div class="sigma-stat">
                                <div class="sigma-stat-label">Max</div>
                                <div class="sigma-stat-value attacker" id="sigma-attacker-max">-</div>
                            </div>
                        </div>
                        <div class="sigma-range" id="sigma-attacker-range">
                            <span title="Â±1Ïƒ: 68.27% of outcomes fall within this range">Â±1Ïƒ (68%)<strong id="sigma-attacker-1s">-</strong></span>
                            <span title="Â±2Ïƒ: 95.45% of outcomes fall within this range">Â±2Ïƒ (95%)<strong id="sigma-attacker-2s">-</strong></span>
                            <span title="Â±3Ïƒ: 99.73% of outcomes fall within this range">Â±3Ïƒ (99.7%)<strong id="sigma-attacker-3s">-</strong></span>
                        </div>
                    </div>
                </div>

                <!-- Casualties Distribution - Defender Inflicted (or Dodges in missile mode) -->
                <div class="result-card" id="defender-hist-card">
                    <div class="histogram-container">
                        <div class="histogram-title-row">
                            <h3 id="defender-hist-title">Casualties Inflicted by Defender</h3>
                        </div>
                        <p class="histogram-explanation" id="defender-hist-explanation">Each bar shows how often that number of casualties occurred across all simulations</p>
                        <div class="histogram-chart">
                            <span class="histogram-y-label">Frequency</span>
                            <div class="histogram" id="hist-defender"></div>
                        </div>
                        <div class="histogram-x-label" id="defender-x-label">Number of Casualties</div>
                        <div class="sigma-stats" id="sigma-defender">
                            <div class="sigma-stat">
                                <div class="sigma-stat-label">Mean (Î¼)</div>
                                <div class="sigma-stat-value defender" id="sigma-defender-mean">-</div>
                            </div>
                            <div class="sigma-stat">
                                <div class="sigma-stat-label">Std Dev (Ïƒ)</div>
                                <div class="sigma-stat-value defender" id="sigma-defender-std">-</div>
                            </div>
                            <div class="sigma-stat">
                                <div class="sigma-stat-label">Min</div>
                                <div class="sigma-stat-value defender" id="sigma-defender-min">-</div>
                            </div>
                            <div class="sigma-stat">
                                <div class="sigma-stat-label">Max</div>
                                <div class="sigma-stat-value defender" id="sigma-defender-max">-</div>
                            </div>
                        </div>
                        <div class="sigma-range" id="sigma-defender-range">
                            <span title="Â±1Ïƒ: 68.27% of outcomes fall within this range">Â±1Ïƒ (68%)<strong id="sigma-defender-1s">-</strong></span>
                            <span title="Â±2Ïƒ: 95.45% of outcomes fall within this range">Â±2Ïƒ (95%)<strong id="sigma-defender-2s">-</strong></span>
                            <span title="Â±3Ïƒ: 99.73% of outcomes fall within this range">Â±3Ïƒ (99.7%)<strong id="sigma-defender-3s">-</strong></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dice Statistics -->
            <div class="result-card">
                <h3>Dice Roll Statistics (per combat, averaged)</h3>
                <div class="dice-breakdown">
                    <div class="dice-side attacker">
                        <h4>Attacker Dice</h4>
                        <div class="dice-stat-row" title="Main dice pool size from unit stats">
                            <span>Main Pool Size:</span>
                            <span id="stat-attacker-base">-</span>
                        </div>
                        <div class="dice-stat-row" title="Extra dice rolled for bonus substitution (50% rule or manual)">
                            <span>Bonus Dice Rolled:</span>
                            <span id="stat-attacker-bonus">-</span>
                        </div>
                        <div class="dice-stat-row" title="How many bonus dice replaced lower main dice">
                            <span>Successful Substitutions:</span>
                            <span id="stat-attacker-subs">-</span>
                        </div>
                        <div class="dice-stat-row" title="Average of the highest die value in the final pool">
                            <span>Avg. Best Die:</span>
                            <span id="stat-attacker-high">-</span>
                        </div>
                        <div class="dice-stat-row" title="Average mean value of all dice in the final pool">
                            <span>Avg. Die Value:</span>
                            <span id="stat-attacker-avg">-</span>
                        </div>
                    </div>
                    <div class="dice-side defender">
                        <h4>Defender Dice</h4>
                        <div class="dice-stat-row" title="Main dice pool size from unit stats">
                            <span>Main Pool Size:</span>
                            <span id="stat-defender-base">-</span>
                        </div>
                        <div class="dice-stat-row" title="Extra dice rolled for bonus substitution (50% rule or manual)">
                            <span>Bonus Dice Rolled:</span>
                            <span id="stat-defender-bonus">-</span>
                        </div>
                        <div class="dice-stat-row" title="How many bonus dice replaced lower main dice">
                            <span>Successful Substitutions:</span>
                            <span id="stat-defender-subs">-</span>
                        </div>
                        <div class="dice-stat-row" title="Average of the highest die value in the final pool">
                            <span>Avg. Best Die:</span>
                            <span id="stat-defender-high">-</span>
                        </div>
                        <div class="dice-stat-row" title="Average mean value of all dice in the final pool">
                            <span>Avg. Die Value:</span>
                            <span id="stat-defender-avg">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Simulation History (outside main for fixed position at bottom) -->
    <section class="history-section" id="history-section">
        <div class="history-container">
            <div class="history-header">
                <h2>Simulation History <span class="history-count" id="history-count" style="display: none;">0</span></h2>
                <button class="history-clear" onclick="clearHistory()">Clear History</button>
            </div>
            <div class="history-list" id="history-list">
                <div class="history-empty">No simulations yet. Run a simulation to see results here.</div>
            </div>
        </div>
    </section>

    <script src="script.js"></script>
</body>
</html>
